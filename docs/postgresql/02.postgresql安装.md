
# 安装postgresql

## 二进制安装

```shell
# ubuntu/debian package install 

sudo apt update
sudo apt -y upgrade
sudo apt -y install vim bash-completion wget
# 添加PostgreSQL的APT源
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
# 添加公钥签名
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
# 更新包列表
sudo apt update
# Install the latest version of PostgreSQL.
# If you want a specific version, use 'postgresql-12' or similar instead of 'postgresql':
sudo apt install postgresql-13 postgresql-client-13

systemctl status postgresql.service 

Ver  Cluster    Port   Status   Owner      Data directory                    Log file
13    main      5432   down     postgres   /var/lib/postgresql/13/main       /var/log/postgresql/postgresql-13-main.log

pg_ctlcluster 13 main start

```

## 编译安装

```shell
# git clone源代码
git clone https://git.postgresql.org/git/postgresql.git 


# 官网下载二进制，一般下比较新的版本
wget https://ftp.postgresql.org/pub/source/v13.2/postgresql-13.2.tar.gz -P /usr/local/src/
wget https://mirrors.tuna.tsinghua.edu.cn/postgresql/source/v14.4/postgresql-14.4.tar.gz -P /usr/local/src/
wget https://mirrors.ustc.edu.cn/postgresql/source/v14.4/postgresql-14.4.tar.gz -P /usr/local/src/
cd /usr/local/src/  && tar -zxvf postgresql-14.4.tar.gz


# 创建用于运行postgre的操作系统账号，并设置强密码
groupadd postgres &&  useradd -g postgres postgres
echo "postgres@123" | passwd --stdin postgres

# 创建安装目录
mkdir -p /data/postgres/14.4/
chown -R postgres:postgres /data/postgres/


cd /usr/local/src/postgresql-14.4
# 如果不自定义目录，后面的安装默认会安到/usr/local/pgsql/bin中
./configure --prefix=/data/postgres/14.4/  --with-systemd
make world-bin
make install

su - postgres

# 初始化
# /usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data
# /usr/local/pgsql/bin/pg_ctl -D /usr/local/pgsql/data -l logfile start
# /usr/local/pgsql/bin/createdb test
# /usr/local/pgsql/bin/psql test

# 启动
# bin目录中的postgres就是postgre server进程的二进制可执行文件

# 直接前台启动，-D指定数据目录，如果没有-D，则用PGDATA环境变量。
postgres -D /usr/local/pgsql/data

# pg_ctl是一个包装命令，可以直接后台启动postgre进程
/usr/local/pgsql/bin/pg_ctl start -l logfile -D /usr/local/pgsql/data



# 注册成系统服务，/etc/systemd/system/postgresql.service
[Unit]
Description=PostgreSQL database server
Documentation=man:postgres(1)
[Service]
Type=notify
User=postgres
ExecStart=/usr/local/pgsql/bin/postgres -D /usr/local/pgsql/data
ExecReload=/bin/kill -HUP $MAINPID
KillMode=mixed
KillSignal=SIGINT
TimeoutSec=infinity
[Install]
WantedBy=multi-user.target

```