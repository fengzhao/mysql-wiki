

# 数据库调优概述

## 一、引言

在网上有很多文章介绍数据库优化知识，但是大部份文章只是对某个一个方面进行说明，而对于我们来说这种介绍并不能很好的掌握优化知识，因为很多介绍只是对一些特定的场景优化的，所以反而有时会产生误导或让人感觉不明白其中的奥妙而对数据库优化感觉很神秘。

很多人总是问如何学习数据库优化，有没有好的教材之类的问题。在书店也看到了许多数据库优化的专业书籍，但是感觉更多是面向DBA或者是PL/SQL开发方面的知识，个人感觉不太适合普通程序员。而要想做到数据库优化的高手，不是花几周，几个月就能达到的，这并不是因为数据库优化有多高深，而是因为要做好优化一方面需要有非常好的技术功底，对操作系统、存储硬件网络、数据库原理等方面有比较扎实的基础知识，另一方面是需要花大量时间对特定的数据库进行实践测试与总结。

作为一个程序员，我们也许不清楚线上正式的服务器硬件配置，我们不可能像DBA那样专业的对数据库进行各种实践测试与总结，但我们都应该非常了解我们SQL的业务逻辑，我们清楚SQL中访问表及字段的数据情况，我们其实只关心我们的SQL是否能尽快返回结果。那程序员如何利用已知的知识进行数据库优化？如何能快速定位SQL性能问题并找到正确的优化方向？



本文读者对像：

- 开发人员：如果你是做数据库开发，那本文的内容非常适合，因为本文是从程序员的角度来谈数据库性能优化。

- 架构师：如果你已经是数据库应用的架构师，那本文的知识你应该清楚90%，否则你可能是一个喜欢折腾的架构师。

- DBA（数据库管理员）：大型数据库优化的知识非常复杂，本文只是从程序员的角度来谈性能优化，DBA除了需要了解这些知识外，还需要深入数据库的内部体系架构来解决问题。






一个数据库系统，其硬件资源(CPU、Disk、SSD...)利用率是不是越高，说明系统调优的越好？

- 用户关注：响应时间(Latency)

- 老板关注：资源有没有浪费？

- 调优关注：保证用户响应时间的基础上，最大限度提高资源利用率。


## 二、如何评级数据库负载情况？


**基准测试**

**基准测试-benchmarking** 是一种测量和评估软件性能指标的活动。
你可以在某个时候通过基准测试建立一个已知的性能水平（称为基准线），当系统的软硬件环境发生变化之后再进行一次基准测试以确定那些变化对性能的影响。
这是基准测试最常见的用途。其他用途包括测定某种负载水平下的性能极限、管理系统或环境的变化、发现可能导致性能问题的条件，等等。

`基准测试`的具体做法是：在系统上运行一系列测试程序并把性能计数器的结果保存起来。这些结构称为"性能指标"。
性能指标通常都保存或归档，并在系统环境的描述中进行注解。比如说，有经验的数据库专业人员会把基准测试的结果以及当时的系统配置和环境一起存入他们的档案。这可以让他们对系统过去和现在的性能表现进行对照比较，确认系统或环境的所有变化。

**基准测试工具和标准**

[TPC-C](https://www.tpc.org/tpcc/)是TPC（事务处理性能委员会）推出的一系列性能测试标准中的一款，自1992年推出，便成为了数据库性能测试的标杆，各个数据库大厂都向TPC委员会提交了测试结果，以期在TPC-C测试的排行榜上拥有一席之地。就像决战紫禁之巅，论剑华山之巅，拥有一席之地的都是成名的大佬们。


TPC-C是业界常用的一套Benchmark，由TPC委员会制定发布，用于评测数据库的联机交易处理（偏向OLTP能力）。
主要涉及10张表，包含了NewOrder（新订单的生成）、Payment（订单付款）、OrderStatus（最近订单查询）、Delivery（配送）和StockLevel（库存缺货状态分析）等五类业务事务模型。

概括来讲，TPC-C是用来衡量在线事务处理的基准，TPC-C提供了一个[说明书](https://www.tpc.org/tpc_documents_current_versions/pdf/tpc-c_v5.11.0.pdf)，用来描述这个基准，在写这篇文章的时候，该说明书的版本是于2010年发布的5.11.0，可以通过访问TPC的网站来获取最新的说明书。

TPC-C模型是模拟一个商品批发公司的销售模型，这个模型涵盖了一个批发公司面向客户对一系列商品进行销售的过程，这包括管理订单，管理库存，管理账号收支等操作。这些操作涉及到仓库、商品、客户、订单等概念，围绕这些概念，构造了数据表格，以及相应的数据库操作。

TPC-C的批发操作在概念上包括5个操作，新订单操作、付款操作、订单状态操作、发货操作，库存操作，这些操作一起构成了完整的批发流程，其中新订单操作是用来衡量tpmC的核心，也就是数据库系统每分钟所能处理的交易数量。下面，我们将详细讲述TPCC的数据库设计与特点，以及各个操作的组成。

TPC-C使用tpmC值（Transactions per Minute）来衡量系统最大有效吞吐量（MQTh，Max Qualified Throughput），其中Transactions以NewOrder Transaction为准，即最终衡量单位为每分钟处理的新订单数。


**基准测试的性能指标**

在衡量一个系统性能时，一定要有可量化的指标，无法量化就无法有效的优化系统性能。
系统每秒可以承载多大请求量，每个请求的响应时间，并发数等都是衡量一个系统的关键性能指标。


**吞吐量-Throughput**

吞吐量指的是单位时间内的事务处理数。这一直是经典的数据库应用测试指标。（高并发系统必备）
在衡量系统性能一直作为一个经典和重要的指标，适用于多用户的交互式应用，比如Web服务器的多用户访问和数据库的多请求操作。

吞吐量常用的计量单位：

- 每秒事务数（TPS）

- 每秒查询数（QPS） ，每秒能够响应的查询次数。

比如，对于Web服务器，用户对某一个页面的一次请求，用户对某系统的一次登录，用户对商品的一次确认支付过程；
对于数据库，一次查询、修改、新增、删除。这些我们都可以看作一个事务或者请求。


**响应时间或延迟**

这个指标用于测试任务所需的整体时间。根据具体的应用，测试的时间单位可能是微秒，毫秒，秒，分钟。
根据不同的时间单位可以计算出平均响应时间，最小响应时间，最大响应时间和所占的百分比。
通常比较多使用的百分比响应时间，例如：95%的响应时间都是5毫秒，则表示任务在95%的时间段内都可以在5毫秒之内完成。
将响应时间绘制成折线图或散点图或直方图 ，可以直观地表现出数据结果集的分布情况。

**并发性**
并发性是一个非重要



###  常用基准测试实际工具


SysBench是 Peter Zaitsev 在2004年最开始发明的，很快，Alexey Kopytov 接管了它的开发工作。到`0.4.12`版本侯就暂停了。

Sysbench是一款基准测试工具，最开始被设计为用来对基于硬件服务器上的MySQ的基准性能测试工具。包括CPU，内存，磁盘IO等等。
它也支持在`MySQL`上的`OLTP`工作负载的测试，OLTP就是在线事务处理，典型的数据库应用场景。

IO测试对应InnoDB的IO性能，注重测试IO密集型
CPU测试对应高并发，多线程的场景，注重测试CPU密集型

它可以覆盖到多种场景：OLTP workloads，read-only or read-write, primary key lookups and primary key updates.



[BenchmarkSQL测试PostgreSQL](https://www.cnblogs.com/mingfan/p/14801579.html)





## 三、数据库访问优化法则简介

要正确的优化SQL，我们需要快速定位能性的瓶颈点，也就是说快速找到我们SQL主要的开销在哪里？而大多数情况性能最慢的设备会是瓶颈点，如下载时网络速度可能会是瓶颈点，本地复制文件时硬盘可能会是瓶颈点，为什么这些一般的工作我们能快速确认瓶颈点呢，因为我们对这些慢速设备的性能数据有一些基本的认识，如网络带宽是2Mbps，硬盘是每分钟7200转等等。因此，为了快速找到SQL的性能瓶颈点，我们也需要了解我们计算机系统的硬件基本性能指标。



![计算机存储结构层次金字塔](../assets/计算机存储结构层次金字塔.png "计算机存储结构层次金字塔")


当今的计算机系统当中，基本上全部都置入了各种各样的存储设备，这些存储设备呈明显的层次结构，它们的特点是容量越大，速度越慢。

因此如果按照容量和速度将它们以图示的方式呈现的话，则看起来就像是一个金字塔，上图就是csapp中的著名的 **计算机存储结构层次金字塔** 图。

从上图可以看出，计算机系统硬件性能从高到代依次为：

```
CPU——Cache(L1-L2-L3)——内存——SSD硬盘——网络——机械硬盘
```

根据数据库知识，我们可以列出每种硬件主要的工作内容：

- CPU及内存：缓存数据访问、比较、排序、事务检测、SQL解析、函数或逻辑运算;

- 网络：结果数据传输、SQL请求、数据同步、日志同步等;

- 硬盘：数据访问、数据写入、日志记录、大数据量排序、大表连接。




这个优化法则归纳为5个层次：

- 减少数据访问（减少磁盘访问）

- 返回更少数据（减少网络传输或磁盘访问）

- 减少交互次数（减少网络传输）

- 减少服务器CPU开销（减少CPU及内存开销）

- 利用更多资源（增加资源）

 

