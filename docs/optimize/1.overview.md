

# 数据库调优概述

## 引言

在网上有很多文章介绍数据库优化知识，但是大部份文章只是对某个一个方面进行说明，而对于我们来说这种介绍并不能很好的掌握优化知识，因为很多介绍只是对一些特定的场景优化的，所以反而有时会产生误导或让人感觉不明白其中的奥妙而对数据库优化感觉很神秘。

很多人总是问如何学习数据库优化，有没有好的教材之类的问题。在书店也看到了许多数据库优化的专业书籍，但是感觉更多是面向DBA或者是PL/SQL开发方面的知识，个人感觉不太适合普通程序员。而要想做到数据库优化的高手，不是花几周，几个月就能达到的，这并不是因为数据库优化有多高深，而是因为要做好优化一方面需要有非常好的技术功底，对操作系统、存储硬件网络、数据库原理等方面有比较扎实的基础知识，另一方面是需要花大量时间对特定的数据库进行实践测试与总结。

作为一个程序员，我们也许不清楚线上正式的服务器硬件配置，我们不可能像DBA那样专业的对数据库进行各种实践测试与总结，但我们都应该非常了解我们SQL的业务逻辑，我们清楚SQL中访问表及字段的数据情况，我们其实只关心我们的SQL是否能尽快返回结果。那程序员如何利用已知的知识进行数据库优化？如何能快速定位SQL性能问题并找到正确的优化方向？



本文读者对像：

- 开发人员：如果你是做数据库开发，那本文的内容非常适合，因为本文是从程序员的角度来谈数据库性能优化。

- 架构师：如果你已经是数据库应用的架构师，那本文的知识你应该清楚90%，否则你可能是一个喜欢折腾的架构师。

- DBA（数据库管理员）：大型数据库优化的知识非常复杂，本文只是从程序员的角度来谈性能优化，DBA除了需要了解这些知识外，还需要深入数据库的内部体系架构来解决问题。






一个数据库系统，其硬件资源(CPU、Disk、SSD...)利用率是不是越高，说明系统调优的越好？

- 用户关注：响应时间(Latency)

- 老板关注：资源有没有浪费？

- 调优关注：保证用户响应时间的基础上，最大限度提高资源利用率。




## 一、数据库访问优化法则简介

要正确的优化SQL，我们需要快速定位能性的瓶颈点，也就是说快速找到我们SQL主要的开销在哪里？而大多数情况性能最慢的设备会是瓶颈点，如下载时网络速度可能会是瓶颈点，本地复制文件时硬盘可能会是瓶颈点，为什么这些一般的工作我们能快速确认瓶颈点呢，因为我们对这些慢速设备的性能数据有一些基本的认识，如网络带宽是2Mbps，硬盘是每分钟7200转等等。因此，为了快速找到SQL的性能瓶颈点，我们也需要了解我们计算机系统的硬件基本性能指标。



![计算机存储结构层次金字塔](../assets/计算机存储结构层次金字塔.png "计算机存储结构层次金字塔")


当今的计算机系统当中，基本上全部都置入了各种各样的存储设备，这些存储设备呈明显的层次结构，它们的特点是容量越大，速度越慢。

因此如果按照容量和速度将它们以图示的方式呈现的话，则看起来就像是一个金字塔，上图就是csapp中的著名的 **计算机存储结构层次金字塔** 图。

从上图可以看出，计算机系统硬件性能从高到代依次为：

```
CPU——Cache(L1-L2-L3)——内存——SSD硬盘——网络——机械硬盘
```

根据数据库知识，我们可以列出每种硬件主要的工作内容：

- CPU及内存：缓存数据访问、比较、排序、事务检测、SQL解析、函数或逻辑运算;

- 网络：结果数据传输、SQL请求、数据同步、日志同步等;

- 硬盘：数据访问、数据写入、日志记录、大数据量排序、大表连接。




这个优化法则归纳为5个层次：

- 减少数据访问（减少磁盘访问）

- 返回更少数据（减少网络传输或磁盘访问）

- 减少交互次数（减少网络传输）

- 减少服务器CPU开销（减少CPU及内存开销）

- 利用更多资源（增加资源）

 

